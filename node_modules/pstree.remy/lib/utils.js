const spawn = require('child_process').spawn;

module.exports = { tree, pidsForTree, getStat };

function getStat() {
<<<<<<< HEAD
  return new Promise((resolve) => {
    const command = `ls /proc | grep -E '^[0-9]+$' | xargs -I{} cat /proc/{}/stat`;
    const spawned = spawn('sh', ['-c', command], {
=======
  return new Promise(resolve => {
    const command = `ls /proc | grep -E '^[0-9]+$' | xargs -I{} cat /proc/{}/stat`;
    const child = spawn('sh', ['-c', command], {
>>>>>>> 0e28bf074f604058bd0f6bbed878eaa2e2cc5fc6
      stdio: ['pipe', 'pipe', 'pipe'],
    });

    var res = '';
<<<<<<< HEAD
    spawned.stdout.on('data', (data) => (res += data));
    spawned.on('close', () => resolve(res));
=======
    child.stdout.on('data', data => (res += data));
    child.on('close', () => resolve(res));
>>>>>>> 0e28bf074f604058bd0f6bbed878eaa2e2cc5fc6
  });
}

function template(s) {
  var stat = null;
  // 'pid', 'comm', 'state', 'ppid', 'pgrp'
  // %d     (%s)    %c       %d      %d
  s.replace(
    /(\d+) \((.*?)\)\s(.+?)\s(\d+)\s/g,
    (all, PID, COMMAND, STAT, PPID) => {
      stat = { PID, COMMAND, PPID, STAT };
    }
  );

  return stat;
}

function tree(stats) {
<<<<<<< HEAD
  const processes = stats.split('\n').map(template).filter(Boolean);
=======
  const processes = stats
    .split('\n')
    .map(template)
    .filter(Boolean);
>>>>>>> 0e28bf074f604058bd0f6bbed878eaa2e2cc5fc6

  return processes;
}

function pidsForTree(tree, pid) {
  if (typeof pid === 'number') {
    pid = pid.toString();
  }
  const parents = [pid];
<<<<<<< HEAD
  const pids = [];

  tree.forEach((proc) => {
    if (parents.indexOf(proc.PPID) !== -1) {
      parents.push(proc.PID);
      pids.push(proc);
    }
  });

  return pids;
=======
  const children = [];

  tree.forEach(proc => {
    if (parents.indexOf(proc.PPID) !== -1) {
      parents.push(proc.PID);
      children.push(proc);
    }
  });

  return children;
>>>>>>> 0e28bf074f604058bd0f6bbed878eaa2e2cc5fc6
}
